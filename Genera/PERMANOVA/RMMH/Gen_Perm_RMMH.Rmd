---
title: "Genera PERMANOVA RMMH"
author: "Alicia June"
output: html_document
---

# Introduction

This document contains code to conduct PERMANOVA comparing the Rushmere and Moore House members of the Yorktown Formation. The distance matrix is calculated using genera ONLY proportional abundance data. 5 samples were used for each member.

The goals of this code are the following:

* Run PERMANOVA on genera ONLY data, compare Rushmere and Moore House Members
* Calculate centroids using DCA coordinates
* Calculate distance matrix with using proportional abundance data to account for sample size
* 5 trials of distance matrix
* 10 trials of PERMANOVA, permutations = 10000

```{r Packages}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(vegan)
```

## Data Preparation: Abundance Data
Abundance data is imported as a csv. Samples are in rows, genera in columns. There is also a column for sample ID and the member each sample is from. If a genus was not present in a sample, the abundance count is 0.
```{r Data prep}
gen_raw<- read_csv("gen_trans.csv", col_names = TRUE)
gen_raw
```

# RM vs MH Samples

### Just Numeric Data
```{r Just nums}
gen_RMMH<- gen_raw[gen_raw$Member != "SM",]
gen_RMMH

#just numeric data
gen_RMMH_num<-gen_RMMH[,3:142] 
gen_RMMH_num
```

### Getting Proportions. 
```{r}
#Converting to proportions
RMMH_perm_data<- (100*(gen_RMMH_num/rowSums(gen_RMMH_num)))
RMMH_perm_data

```

## Data Preparation: DCA Data
```{r Import DCA data}
dcadata<- read_csv("gen_dca.csv", col_names = TRUE)
dcadata

dcadataRMMH<- dcadata[dcadata$Member != "SM",]
dcadataRMMH

#Extracting DCA scores
dca_scoresRMMH<- dcadataRMMH[,3:4]
dca_scoresRMMH

```

## Plotting

Step 1: Find centroids
```{r Finding Centroids}
dcagroup_centroids_RMMH <- data.frame(
  Member = c("RM", "MH"),
  Centroid_X = c(mean(dca_scoresRMMH$`Axis 1`[dcadataRMMH$Member == "RM"]),
                 mean(dca_scoresRMMH$`Axis 1`[dcadataRMMH$Member == "MH"])),
  Centroid_Y = c(mean(dca_scoresRMMH$`Axis 2`[dcadataRMMH$Member == "RM"]),
                 mean(dca_scoresRMMH$`Axis 2`[dcadataRMMH$Member == "MH"]))
)


```

Step 2: Create df for ggplot
```{r Create df for ggplot}
dcaplot_data_RMMH <-data.frame(
  Member = dcadataRMMH$Member,
  DC1 = dca_scoresRMMH$`Axis 1`,
  DC2 = dca_scoresRMMH$`Axis 2`,
  xend = c(rep(dcagroup_centroids_RMMH[1,2],5), rep(dcagroup_centroids_RMMH[2,2],5)),
  yend = c(rep(dcagroup_centroids_RMMH[1,3],5), rep(dcagroup_centroids_RMMH[2,3],5))
)

dcaplot_data_RMMH
```

Step 3: Plot the DCA

* Plot samples, coloring based on location
* Draw the ellipse and the segments

```{r DCA plot}
ggplot(dcaplot_data_RMMH, aes(DC1,DC2))+
  geom_point(aes(color = Member), size = 2) +
  stat_ellipse(geom = "polygon", alpha = 0.04, aes(group = Member),
               color = "black", fill = "blue")+
  geom_point(data = dcagroup_centroids_RMMH, aes(x = Centroid_X, y = Centroid_Y),
             color = "black", size = 2, shape = 7)+
  geom_segment(data = dcaplot_data_RMMH, aes(x =DC1, y = DC2, 
                                        xend = xend, yend = yend, color = Member), alpha = 0.5)

```

# Running PERMANOVA

## Distance Matrix
```{r}
perm_distRMMH<-vegdist(RMMH_perm_data, method = 'bray')
perm_distRMMH

```

Creating df of distance matrix. 
```{r}
#Create empty matrix
dist_mat_RMMH= matrix(0, nrow = 10, ncol = 10)

#Setting below diagonal to perm_dost values, and above the diagonal to empty
dist_mat_RMMH[lower.tri(dist_mat_RMMH)] <- perm_distRMMH
dist_mat_RMMH[upper.tri(dist_mat_RMMH)]<- ""
dist_mat_RMMH

#making it a df
perm_distRMMH_df<- as.data.frame(dist_mat_RMMH, row.names = NULL)
perm_distRMMH_df

#setting col and rownames so we can see what distance we are calculating
rownames(perm_distRMMH_df)<- gen_RMMH$`Sample ID`
colnames(perm_distRMMH_df)<- gen_RMMH$`Sample ID`

write_csv(perm_distRMMH_df, "gen_dist_RMMH.csv")
perm_distRMMH_df
```

## Assumption
```{r}
#Assumptions- I don't think this applies to us, but keeping it in.
dispersion<-betadisper(perm_distRMMH, group=gen_RMMH$Member,type = "centroid")

plot(dispersion)

anova(dispersion)

```

## PERMANOVA Trials

Repeated trials of PERMANOVA at 10,000 permutations. Will average p-values later. 

Trial 00
```{r Trial 00}
Perma_result <- adonis2(perm_distRMMH~as.factor(dcaplot_data_RMMH$Member), data = perm_distRMMH,
                        permutations = 10000)
Perma_result

```
Trial 01
```{r Trial 01}
Perma_result1 <- adonis2(perm_distRMMH~as.factor(dcaplot_data_RMMH$Member), data = perm_distRMMH,
                         permutations = 10000)
Perma_result1

#Extracting perm results
permustats_results1<- permustats(Perma_result1)
#permustats_results1

#calculating mean and se
means_and_se1<- mean_se(permustats_results1$permutations, mult = 1)

```

Trial 02
```{r Trial 02}
Perma_result2 <- adonis2(perm_distRMMH~as.factor(dcaplot_data_RMMH$Member), data = perm_distRMMH,
                         permutations = 10000)
Perma_result2

#Extracting perm results
permustats_results2<- permustats(Perma_result2)
#permustats_results2

#calculating mean and se
means_and_se2<- mean_se(permustats_results2$permutations, mult = 1)

```

Trial 03
```{r Trial 03}
Perma_result3 <- adonis2(perm_distRMMH~as.factor(dcaplot_data_RMMH$Member), data = perm_distRMMH,
                         permutations = 10000)
Perma_result3

#Extracting perm results
permustats_results3<- permustats(Perma_result3)
#permustats_results3

#calculating mean and se
means_and_se3<- mean_se(permustats_results3$permutations, mult = 1)

```

Trial 04
```{r Trial 04}
Perma_result4 <- adonis2(perm_distRMMH~as.factor(dcaplot_data_RMMH$Member), data = perm_distRMMH,
                         permutations = 10000)
Perma_result4

#Extracting perm results
permustats_results4<- permustats(Perma_result4)
#permustats_results4

#calculating mean and se
means_and_se4<- mean_se(permustats_results4$permutations, mult = 1)

```

Trial 05
```{r Trial 05}
Perma_result5 <- adonis2(perm_distRMMH~as.factor(dcaplot_data_RMMH$Member), data = perm_distRMMH,
                         permutations = 10000)
Perma_result5

#Extracting perm results
permustats_results5<- permustats(Perma_result5)
#permustats_results5

#calculating mean and se
means_and_se5<- mean_se(permustats_results5$permutations, mult = 1)

```

Trial 06
```{r Trial 06}
Perma_result6 <- adonis2(perm_distRMMH~as.factor(dcaplot_data_RMMH$Member), data = perm_distRMMH,
                         permutations = 10000)
Perma_result6

#Extracting perm results
permustats_results6<- permustats(Perma_result6)
#permustats_results6

#calculating mean and se
means_and_se6<- mean_se(permustats_results6$permutations, mult = 1)

```

Trial 07
```{r Trial 07}
Perma_result7 <- adonis2(perm_distRMMH~as.factor(dcaplot_data_RMMH$Member), data = perm_distRMMH,
                         permutations = 10000)
Perma_result7

#Extracting perm results
permustats_results7<- permustats(Perma_result7)
#permustats_results7

#calculating mean and se
means_and_se7<- mean_se(permustats_results7$permutations, mult = 1)

```

Trial 08
```{r Trial 08}
Perma_result8 <- adonis2(perm_distRMMH~as.factor(dcaplot_data_RMMH$Member), data = perm_distRMMH,
                         permutations = 10000)
Perma_result8

#Extracting perm results
permustats_results8<- permustats(Perma_result8)
#permustats_results8

#calculating mean and se
means_and_se8<- mean_se(permustats_results8$permutations, mult = 1)

```

Trial 09
```{r Trial 09}
Perma_result9 <- adonis2(perm_distRMMH~as.factor(dcaplot_data_RMMH$Member), data = perm_distRMMH,
                         permutations = 10000)
Perma_result9

#Extracting perm results
permustats_results9<- permustats(Perma_result9)
#permustats_results9

#calculating mean and se
means_and_se9<- mean_se(permustats_results9$permutations, mult = 1)

```
Trial 10
```{r Trial 10}
Perma_result10 <- adonis2(perm_distRMMH~as.factor(dcaplot_data_RMMH$Member), data = perm_distRMMH,
                         permutations = 10000)
Perma_result10

#Extracting perm results
permustats_results10<- permustats(Perma_result10)
#permustats_results10

#calculating mean and se
means_and_se10<- mean_se(permustats_results10$permutations, mult = 1)

```





